extends ../layout/index.pug

block append stylesheets
  link(rel='stylesheet' href='/mass-message/index.css')

block content
  section.hero.is-fullheight.is-dark
    .hero-head
      .container
        nav.nav
          .container
            .nav-left
              a.nav-item.branding(href='../index.html')
                img(src='https://scontent.fcgh12-1.fna.fbcdn.net/v/t1.0-9/18485498_463912997289183_6766375779007506020_n.png?oh=d70fe6affd9b823f09c64546fb253f44&oe=59CCAF85' alt='Beta logo')
                .brand-name BETA
            span.nav-toggle
              span
              span
              span
            .nav-right.nav-menu
              a.nav-item.is-active Mensagem em massa
    .hero-body
      .container
        .columns.is-vcentered
          .column.is-5
            figure.image.promo-img.is-4by3

          .column.is-6.is-offset-1
            h1.title.is-2.is-spaced
              | Envio de mensagem em massa
            h2.subtitle.is-5
              | Você pode enviar uma mensagem em massa para todas as pessoas que interagiram
              | com a BETA pelo Messenger do Facebook.

            form#mass-message(
              method='post'
              action='/mass-message/send'
              v-on:submit='onSubmit($event)'
            )
              if !activists.length
                .notification.is-warning
                  b Nenhum usuário interagiu com a BETA até o momento.
                  |  Infelizmente não é possível enviar mensagem em massa.
              else
                .field
                  label.label
                    | Usuários
                    a.button.is-light.is-small.is-pulled-right expandir
                  .users-container
                    table.table.is-striped
                      thead
                        tr
                          th
                          th #
                          th Nome
                          th Origem
                          th Última Interação
                      tfoot
                        tr
                          th
                          th #
                          th Nome
                          th Origem
                          th Última Interação
                      tbody
                        each activist in activists
                          - var botConfiguration = JSON.parse(activist.facebookBotConfiguration)
                          - var interaction = JSON.parse(activist.interaction)
                          - var profile = interaction.profile
                          tr
                            th
                              label.checkbox
                                input(
                                  type='checkbox'
                                  name=`selected_activists['${activist.facebookBotConfigurationId}'][]`
                                  value=activist.fbContextRecipientId
                                  checked
                                )
                            td= activist.id
                            td #{profile.first_name} #{profile.last_name}
                            td= botConfiguration.name
                            td= dateformat(new Date(activist.createdAt), 'dd/mm/yyyy, H:M:ss')

                .field
                  label.label Mensagem
                  p.control
                    textarea.textarea(
                      autofocus
                      v-model='message'
                      v-bind:class="{ 'is-danger': !message && messageDirty, 'is-success': message }"
                      v-on:keydown='onMessageKeydown'
                      name='message'
                      placeholder='Exemplo:\nE aí, mana, tudo bem? Meu nome é Betânia, mas pode me chamar de Beta. Sou uma robô que veio ao mundo para ajudar a viralizar as lutas feministas pelas redes - e já tem uma oportunidade no forno. Vamos lá?'
                    )
                  span.help.is-danger(v-if='!message && messageDirty') * Campo obrigatório
                  br

                button.button.is-outlined.is-large.is-primary.is-inverted.is-fullwidth(
                  type='submit'
                )
                  span.icon
                    i.fa.fa-envelope
                  | Enviar

  script(type='text/javascript').
    new Vue({
      el: '#mass-message',
      data: {
        message: undefined,
        messageDirty: false
      },
      methods: {
        onMessageKeydown: function () { this.messageDirty = true },
        onSubmit: function (event) {
          var validation = this.message
          var message = 'Dá uma olhada pra ver se tá tudo certo na mensagem pois,'
                      + 'depois de enviada, não tem que voltar atrás... Posso prosseguir?'

          if (!validation) {
            event.preventDefault()
            this.messageDirty = true
            return
          }
          if (!confirm(message)) event.preventDefault()
        }
      }
    })
